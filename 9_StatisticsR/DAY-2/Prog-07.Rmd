---
title: "Exploratory data analysis"
author: "Montserrat Guillen"
date: "2017"
output:
  pdf_document:
    toc: yes
  word_document: default
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
---

******
# Introduction
******

This is a very short introduction to the exploration of data using RStudio and Rmarkdown. 

This document sequentially applies a set of Data Science techniques to gain insights from the Direct Marketing campaign of a Portuguese Banking Institution. 

There are two public data sets that are linked to the article by S. Moro, P. Cortez and P. Rita. A Data-Driven Approach to Predict the Success of Bank Telemarketing. Decision Support Systems, Elsevier, 62:22-31, June 2014. The two datasets ontain similar information, but not exactly the same.. Here we will analyse the smaller data set (called **bank.csv**). The file can be downloaded from: 
https://archive.ics.uci.edu/ml/datasets/bank+marketing

or (for this course)

http://www.ub.edu/rfa/docs/DATA/bank.csv



First we need to read the data from the file "bank.csv".


```{r,eval=TRUE,echo=TRUE}
#setwd("..")
### CHUNK 1

bank<-read.table(file="bank.csv",header=T,sep=";")
```

The dataset contains information on ```r nrow(bank)``` clients and ```r ncol(bank)```variables.

Note that the input variables are not the same in this file than in the "additional" data set, that has different attributes. There are many recent analysis of all these data but one has to check which exact data file is used in each case.

Input variables:

   # bank client data:

   1 - age (numeric)

   2 - job : type of job (categorical: "admin.","unknown","unemployed","management","housemaid","entrepreneur","student", "blue-collar","self-employed","retired","technician","services") 
   
   3 - marital : marital status (categorical: "married","divorced","single"; note: "divorced" means divorced or widowed)
   
   4 - education (categorical: "unknown","secondary","primary","tertiary")
   
   5 - default: has credit in default? (binary: "yes","no")
   
   6 - balance: average yearly balance, in euros (numeric) 
   
   7 - housing: has housing loan? (binary: "yes","no")
   
   8 - loan: has personal loan? (binary: "yes","no")
   
   # related with the last contact of the current campaign:
   
   9 - contact: contact communication type (categorical: "unknown","telephone","cellular") 
  
  10 - day: last contact day of the month (numeric)
  
  11 - month: last contact month of year (categorical: "jan", "feb", "mar", ..., "nov", "dec")

  12 - duration: last contact duration, in seconds (numeric)

   # other attributes:

  13 - campaign: number of contacts performed during this campaign and for this client (numeric, includes last contact)

  14 - pdays: number of days that passed by after the client was last contacted from a previous campaign (numeric, -1 means client was not previously contacted)
 
  15 - previous: number of contacts performed before this campaign and for this client (numeric)
  
  16 - poutcome: outcome of the previous marketing campaign (categorical: "unknown","other","failure","success")

  Output variable (desired target):

  17 - **y - has the client subscribed a term deposit? (binary: "yes","no")**
  
## Names of the variables

We print de names of the variables:

```{r,eval=TRUE,echo=TRUE}

### CHUNK 2

colnames(bank)
```

We will use function **attach** so that we can call variables just by their name instead of **bank$name**.

```{r,eval=TRUE,echo=TRUE}

### CHUNK 3

attach(bank)

# search() tells you the search order for objects:
search()
```

## An overview of basic Data Analysis for this dataset

image: ![](Chart.png)

  
## Required packages

The function, "install.packages()", downloads and installs R programming language packages from CRAN-like repositories or from local files. If these packages are not installed, they shoule be installed before running the code.

```{r,eval=TRUE,echo=TRUE, warnings=FALSE}

### CHUNK 4

# I've set warnings=FALSE to avoid warnings on packages name collisions.

# Required Packages
# install.packages("ggplot2")   # plotting
# install.packages("dplyr")     # data management
# install.packages("cluster")   # kmeans clustering
# install.packages("HSAUR")     # silhouette plotting
# install.packages("fpc")       # numbers cluster plot
# install.packages("lattice")   # cluster plotting
# install.packages("rpart")     # Decision Tress data classification
# install.packages("kernlab")   # Support Vector Machines machine learning
# install.packages("randomForest") # Random Forest machine learning

library(ggplot2)
library(dplyr)
#library(cluster)
#library(HSAUR)
#library(fpc)
#library(lattice)
#library(rpart)
#library(kernlab)
#library(randomForest)
```


## Session information 

This is information on the R version used in this example:

```{r,eval=TRUE,echo=TRUE}

### CHUNK 5

sessionInfo()
```


## Print of first six records (all variables)

```{r,eval=TRUE,echo=TRUE}

### CHUNK 6

head(bank)
```

We can also use: 

```{r,eval=TRUE,echo=TRUE}

### CHUNK 7

glimpse(bank)
```

# Data visualization

## Data Summary of the Bank Dataset

We check all variables and conclude a few on interesting things about our data.

```{r,eval=TRUE,echo=TRUE}

### CHUNK 8

dim(bank)
summary(bank)
```
What about term diposit and default? Is it possible?

```{r}

### CHUNK 9

table(y,default)
```

Who are these 9 people?

```{r}

### CHUNK 10

default_termdip=subset(bank, default=='yes' & y=='yes')
glimpse(default_termdip)
```

## Specific statistical measures

```{r,eval=TRUE,echo=TRUE}

### CHUNK 11

sapply(bank[c("age", "duration")], median, 1)

```

```{r,eval=TRUE,echo=TRUE}

### CHUNK 12

tapply(age, y, median)

tapply(duration, y, median)

```
## Tables and proportions

```{r}

### CHUNK 13

table(y)
prop.table(table(y)) 
round(prop.table(table(y))*100, 2)
```


# Histograms of age and duration

## Regular histograms

Easy histogram with 35 bins and label.

```{r,eval=TRUE,echo=TRUE}

### CHUNK 14

ggplot(data=bank, aes(age)) + geom_histogram(bins=35)+xlab("age")

```

Easy histogram with 40 bins and lanel

```{r}

### CHUNK 15

ggplot(data=bank, aes(duration)) + geom_histogram(bins=40)+xlab("duration")
```
 
## With density plots
 
```{r,eval=TRUE,echo=TRUE}

### CHUNK 16

ggplot(data=bank, aes(age)) + geom_density()

```
 
 
## Plot colors

Palettes: 

Diverging
BrBG, PiYG, PRGn, PuOr, RdBu, RdGy, RdYlBu, RdYlGn, Spectral

Qualitative
Accent, Dark2, Paired, Pastel1, Pastel2, Set1, Set2, Set3

Sequential
Blues, BuGn, BuPu, GnBu, Greens, Greys, Oranges, OrRd, PuBu, PuBuGn, PuRd, Purples, RdPu, Reds, YlGn, YlGnBu, YlOrBr, YlOrRd


## Mutiple dimension graphics

We have a problem with the variable **pdays**, because when the customer was not contacted, the value is -1.

```{r,eval=TRUE,echo=TRUE}

### CHUNK 17

  t2=subset(bank, pdays>=0 & duration<60)
 ggplot(t2) +
  geom_tile(aes(age, duration,fill = pdays))+
   scale_fill_distiller(palette = "Spectral")
 
```


# Plots

# Vertical bars: 

## Grouping and showing frequencies

```{r,eval=TRUE,echo=TRUE}

### CHUNK 18

t=data.frame(table(y, marital))
ggplot(t, aes(x=marital, y=Freq, fill=y)) +
  geom_bar(position='dodge', stat='identity')
```

## Grouping bars and showing percent

You can try a number of different palettes "Greens", "Set1", "Set2", etc...

```{r,eval=TRUE,echo=TRUE}

### CHUNK 19

t=data.frame(prop.table(table(y ,marital), 2))
ggplot(t, aes(x=marital, y=Freq*100, fill=y)) +
  geom_bar(position='dodge', stat='identity')+
  ylab("Percent (%)")+ scale_fill_brewer("Term Diposit", palette="Spectral")
```

## Miscelaneous plots  and boxplots

The simplest thing to do is a box plot.


```{r,eval=TRUE,echo=TRUE}

### CHUNK 20

ggplot(data=bank, aes(pdays))+ geom_density()+scale_fill_brewer()

ggplot(data=t2, aes(pdays))+ geom_density()+scale_fill_brewer()

plot(y, age)


```

## Simple Pie charts

```{r,eval=TRUE,echo=TRUE}

### CHUNK 21

ggplot(bank, aes(x=factor(1), fill=y))+
  geom_bar(width = 1)+
  coord_polar("y")

```

We now use another palette and labeling. 

```{r,eval=TRUE,echo=TRUE}

### CHUNK 22

ggplot(bank, aes(x=factor(1), fill=y))+
  geom_bar(width = 1)+
  coord_polar("y")+ scale_fill_brewer("Blues")

blank_theme <- theme_minimal()+
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  plot.title=element_text(size=14, face="bold")
  )

ggplot(bank, aes(x=factor(1), fill=y))+
  geom_bar(width = 1)+
  coord_polar("y")+ scale_fill_brewer("Term Diposit")+ blank_theme +
  theme(axis.text.x=element_blank())+
  theme(axis.text.y=element_blank())
  
```


# Evolution over time

## Example of a double scale graphic

```{r,eval=TRUE,echo=TRUE}

### CHUNK 23

t3=data.frame(prop.table(table(y, month),2))
t3$month_order=factor(as.character(t3$month), levels = c("jan","feb","mar", "apr", "may", "jun","jul", "aug", "sep", "oct", "nov", "dec"))

t4 = group_by(bank, month) %>% summarise(Yearlybalance=mean(balance)) %>% ungroup()
t4$month_order=factor(as.character(t4$month), levels = c("jan","feb","mar", "apr", "may", "jun","jul", "aug", "sep", "oct", "nov", "dec"))


ggplot(subset(t3, y=='yes'), aes(x=month_order, y=Freq*100)) + 
  theme(plot.background = element_blank(),
              # panel.grid.minor = element_blank(),
              #  panel.grid.major = element_blank(),
                panel.border = element_blank(),
                panel.background = element_blank(),
                axis.ticks = element_blank() ) +
    geom_linerange(subset(t3, y=='yes'), mapping=aes(x=month_order, ymin=0, ymax=Freq*100), colour = "wheat2", alpha=1, size=5) +
   geom_line(t4, mapping=aes(x=month_order, y=Yearlybalance/200, group=1, colour= "For those contacted")) +
scale_y_continuous(sec.axis = sec_axis(~.*200, name = "Mean Yr balance")) +
scale_colour_manual(values = c("red")) +
 labs(y = "Term diposit [%]",
                x = " Month ",
                colour = "Mean Year balance") +
 theme(legend.position = c(0.8, 0.9))





``` 
    
## A function that produces a series of graphics

```{r}

### CHUNK 24

table(bank$campaign)
bank$campaign2=ifelse(bank$campaign>=10, 10, bank$campaign)
table(bank$campaign2)

CoolPlot<-function(icampaign){
 
df=subset(bank, bank$campaign2==icampaign)  
t3=data.frame(prop.table(table(df$y, df$month),2))

ggplot(t3, aes(x=Var2, y=Freq*100, fill=Var1)) +
  geom_bar(position='dodge', stat='identity')+
  ylab("Percent (%)")+ scale_fill_brewer("Term Diposit", palette="Spectral")
}



par(mfrow=c(5,2))

for (i in 1:10){
  aa<-CoolPlot(i)
  print(aa)
}
```

# Reference

More information on graphics with R (ggplot2)

http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html
